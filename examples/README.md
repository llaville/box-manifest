<!-- markdownlint-disable MD013 -->
# Examples

Table Of Contents :

1. A `phar-manifest.php` script that demonstrate how to use programmatically the API to generate manifests in different format.
1. A basic `app-fixtures` application that will be support of a tutorial.

## Tutorial

On this tutorial we will use the sources from `examples/app-fixtures` directory.

## Use only the [`metadata`][metadata-box-setting] BOX setting

If you still want to have your manifest available on the PHAR `metadata` field, the callable capability
of the [`metadata`][metadata-box-setting] BOX setting is for you.

Consider the BOX config file `app-fixtures-box.json` with following contents :

```json
{
    "main": null,
    "output": "app-fixtures.phar",
    "directories": ["bin", "src", "vendor"],
    "directories-bin": ["../../vendor/humbug/box/res/requirement-checker"],
    "metadata": "MyCallbacks::manifest",
    "compression": "GZ"
}
```

You have a define a [PHP callable][php-callables] like this one

```php
<?php
// bootstrap.php

use Bartlett\BoxManifest\Helper\ManifestHelper;

use Composer\InstalledVersions;

class MyCallbacks
{
    public static function metadata(): ?string
    {
        $rootPackage = InstalledVersions::getRootPackage();
        return sprintf('%s@%s', $rootPackage['pretty_version'], substr($rootPackage['reference'], 0, 7));
    }

    public static function manifest(array $resources = ['manifest.txt', 'manifest.xml', 'sbom.xml', 'sbom.json']): ?string
    {
        return (new ManifestHelper())->get($resources) ?? self::metadata();
    }
}
```

The `resources` argument of `MyCallbacks::manifest` callable identify a priority of files list that try to search for in
the root of the PHP Archive.
The `ManifestHelper` component is in charge to find and retrieve the resource contents (if exists).
Otherwise, fallback strategy is to return the contents that will be used for the PHAR `metadata` field.

Compile your PHP Archive as usal, either with standard `vendor/bin/box compile` command or the `bin/box-compile` (single command application).

```shell
bin/box-compile --config app-fixtures-box.json -v
```

<details>
<summary>TL;DR output</summary>

```text
    ____
   / __ )____  _  __
  / __  / __ \| |/_/
 / /_/ / /_/ />  <
/_____/\____/_/|_|


Box version 4.3.8@5534406

 // Loading the configuration file "app-fixtures-box.json".

ðŸ”¨  Building the PHAR "/shared/backups/bartlett/box-manifest/examples/app-fixtures/app-fixtures.phar"

? Removing the existing PHAR "/shared/backups/bartlett/box-manifest/examples/app-fixtures/app-fixtures.phar"
? Checking Composer compatibility
    > '/usr/local/bin/composer' '--version'
    > 2.5.4 (Box requires ^2.2.0)
    > Supported version detected
? No compactor to register
? Adding main file: /shared/backups/bartlett/box-manifest/examples/app-fixtures/index.php
? Adding requirements checker
? Adding binary files
    > 34 file(s)
? Auto-discover files? No
? Exclude dev files? Yes
? Adding files
    > 25 file(s)
? Generating new stub
  - Using shebang line: #!/usr/bin/env php
  - Using banner:
    > Generated by Humbug Box 4.3.8@5534406.
    >
    > @link https://github.com/humbug/box
? Setting metadata
  - MyCallbacks::manifest
? Dumping the Composer autoloader
    > '/usr/local/bin/composer' 'dump-autoload' '--classmap-authoritative' '--no-dev' '--ansi'
Generating optimized autoload files (authoritative)
Generated optimized autoload files (authoritative) containing 1 classes

? Removing the Composer dump artefacts
? Compressing with the algorithm "GZ"
    > Warning: the extension "zlib" will now be required to execute the PHAR
? Setting file permissions to 0755
* Done.

No recommendation found.
No warning found.

 // PHAR: 58 files (46.67KB)
 // You can inspect the generated PHAR with the "info" command.

 // Memory usage: 12.32MB (peak: 12.78MB), time: <1sec

```

</details>

Look in especially about this one :

```text
? Setting metadata
  - MyCallbacks::manifest
```

The `"metadata": "MyCallbacks::manifest"` setting of the BOX config file is printed rather than be replaced by its results
because the callable defined is out of autoloader scope !

**CAUTION** Your callable function must be readable by your autoloader.

That means, you should specify by the `--bootstrap` option where is the file that contains the callable.

**IMPORTANT** Use the `bin/box-compile` command here, because standard BOX compile version does not support the `--bootstrap` option.

```shell
bin/box-compile --config app-fixtures-box.json --bootstrap bootstrap.php
```

And we will get the expected results :

```text
? Setting metadata
  - 3.x-dev@b526ccc
```

## Use generated files produced by `bin/box-manifest` command

Begins by generate the manifest files.

1. First we will build a SBOM XML version following default (CycloneDX) specification 1.4

```shell
box-manifest --config app-fixtures-box.json --output-file sbom.xml -v
```

That prints such results :

```text

 // Loading the configuration file "app-fixtures-box.json".

 // Writing manifest to file "/path/to/examples/app-fixtures/sbom.xml"

```

2. Second we will build a decorated TEXT version

```shell
box-manifest --config app-fixtures-box.json --output-file manifest.txt -v
```

That prints such results :

```text

 // Loading the configuration file "app-fixtures-box.json".

 // Writing manifest to file "/path/to/examples/app-fixtures/manifest.txt"

```

Now its turn to declare these files to the BOX config file, with :

```json
{
    "files-bin": [
      "sbom.xml",
      "manifest.txt"
    ]
}
```

Then finally, compile your PHP Archive with (or without `--boostrap` option),
the metadata contents is only used as fallback contents in case you forgot to declare `files-bin` entries.

```shell
bin/box-compile --config app-fixtures-box.json --bootstrap bootstrap.php -v
```

<details>
<summary>TL;DR output</summary>

```text
    ____
   / __ )____  _  __
  / __  / __ \| |/_/
 / /_/ / /_/ />  <
/_____/\____/_/|_|


Box version 4.3.8@5534406

 // Loading the configuration file "app-fixtures-box.json".

ðŸ”¨  Building the PHAR "/shared/backups/bartlett/box-manifest/examples/app-fixtures/app-fixtures.phar"

? Removing the existing PHAR "/shared/backups/bartlett/box-manifest/examples/app-fixtures/app-fixtures.phar"
? Checking Composer compatibility
    > '/usr/local/bin/composer' '--version'
    > 2.5.4 (Box requires ^2.2.0)
    > Supported version detected
? No compactor to register
? Adding main file: /shared/backups/bartlett/box-manifest/examples/app-fixtures/index.php
? Adding requirements checker
? Adding binary files
    > 36 file(s)
? Auto-discover files? No
? Exclude dev files? Yes
? Adding files
    > 25 file(s)
? Generating new stub
  - Using shebang line: #!/usr/bin/env php
  - Using banner:
    > Generated by Humbug Box 4.3.8@5534406.
    >
    > @link https://github.com/humbug/box
? Setting metadata
  - root/app-fixtures: 3.x-dev@9661882
psr/log: 3.0.0
? Dumping the Composer autoloader
    > '/usr/local/bin/composer' 'dump-autoload' '--classmap-authoritative' '--no-dev' '--ansi'
Generating optimized autoload files (authoritative)
Generated optimized autoload files (authoritative) containing 1 classes

? Removing the Composer dump artefacts
? Compressing with the algorithm "GZ"
    > Warning: the extension "zlib" will now be required to execute the PHAR
? Setting file permissions to 0755
* Done.

No recommendation found.
No warning found.

 // PHAR: 60 files (47.12KB)
 // You can inspect the generated PHAR with the "info" command.

 // Memory usage: 12.35MB (peak: 12.81MB), time: <1sec

```

</details>

To verify contents of PHAR `metadata` field, you can run following command with CLI

```shell
php -r "var_export((new Phar(getcwd() . '/app-fixtures.phar'))->getMetadata());"
```

And contents of binary files with following CLI command

```shell
php -r "var_export((new Phar(getcwd() . '/app-fixtures.phar'))['sbom.xml']->getContent());"
or
php -r "var_export((new Phar(getcwd() . '/app-fixtures.phar'))['manifest.txt']->getContent());"
```

## Last but not the least, include a custom stub to display manifests

Of course running CLI commands to verify contents is not so hard, but we may expect a better user experience.
Adding a `--manifest` option that will either :
- search for the first manifest available in a priority files list
- show a specific version

Create, for example this custom stub :

```php
<?php
Phar::mapPhar('app-fixtures-alias.phar');

if ($argc > 1 && $argv[1] === '--manifest') {
    $resources = ($argc > 2 && !str_starts_with($argv[2], '-')) ? [$argv[2]] : ['manifest.txt', 'manifest.xml', 'sbom.xml', 'sbom.json'];

    foreach ($resources as $resource) {
        $filename = "phar://app-fixtures-alias.phar/{$resource}";
        if (file_exists($filename)) {
            echo (file_get_contents($filename));
            $status = 0;
            break;
        } elseif (count($resources) === 1) {
            echo sprintf('Manifest "%s" is not available in this PHP Archive.', $resource), PHP_EOL;
            $status = 1;
            break;
        }
    }
    exit($status);
}

require 'phar://app-fixtures-alias.phar/.box/bin/check-requirements.php';
require 'phar://app-fixtures-alias.phar/index.php';

__HALT_COMPILER(); ?>
```

And declare it, in the BOX config file `app-fixtures-box.json`, with excerpt :

```json
{
  "stub": "app-fixtures-stub.php"
}
```

Then re-compile for the last time your PHP Archive.

You are now able to display either the first manifest available (`manifest.txt` is included and is on top or priority list)

```shell
./app-fixtures.phar --manifest
```

That prints following results :

```text
root/app-fixtures: 3.x-dev@9661882
psr/log: 3.0.0
```

Or a specific version, like :

```shell
./app-fixtures.phar --manifest sbom.xml
```

That prints following results :

```xml
<?xml version="1.0" encoding="UTF-8"?>
<bom xmlns="http://cyclonedx.org/schema/bom/1.4" version="1">
  <metadata>
    <tools>
      <tool>
        <vendor><![CDATA[box-project]]></vendor>
        <name><![CDATA[box]]></name>
        <version><![CDATA[4.3.8@5534406]]></version>
      </tool>
    </tools>
  </metadata>
  <components>
    <component type="library" bom-ref="pkg:composer/psr/log@3.0.0">
      <group><![CDATA[psr]]></group>
      <name><![CDATA[log]]></name>
      <version><![CDATA[3.0.0]]></version>
      <purl><![CDATA[pkg:composer/psr/log@3.0.0]]></purl>
    </component>
  </components>
  <dependencies>
    <dependency ref="pkg:composer/psr/log@3.0.0"/>
  </dependencies>
</bom>
```

And if you ask for an unavailable version into the PHP Archive,

```shell
./app-fixtures.phar --manifest sbom.json
```

You'll get

```text
Manifest "sbom.json" is not available in this PHP Archive.
```


[metadata-box-setting]: https://github.com/box-project/box/blob/main/doc/configuration.md#metadata-metadata
[php-callables]: https://www.php.net/manual/en/language.types.callable.php
