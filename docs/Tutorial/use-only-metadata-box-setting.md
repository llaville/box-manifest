<!-- markdownlint-disable MD013 MD029 MD033 -->
# Use only the [`metadata`][metadata-box-setting] BOX setting

If you still want to have your manifest available on the PHAR `metadata` field, the callable capability
of the [`metadata`][metadata-box-setting] BOX setting is for you.

Consider the BOX config file `app-fixtures-box.json` with following contents :

```json
{
    "main": null,
    "output": "app-fixtures.phar",
    "directories": ["bin", "src", "vendor"],
    "directories-bin": ["../../vendor/humbug/box/res/requirement-checker"],
    "metadata": "MyCallbacks::manifest",
    "compression": "GZ"
}
```

You have to define a [PHP callable][php-callables] like this one

```php
<?php
// bootstrap.php

use Bartlett\BoxManifest\Helper\ManifestHelper;

use Composer\InstalledVersions;

class MyCallbacks
{
    public static function metadata(): ?string
    {
        $rootPackage = InstalledVersions::getRootPackage();
        return sprintf('%s@%s', $rootPackage['pretty_version'], substr($rootPackage['reference'], 0, 7));
    }

    public static function manifest(array $resources = ['manifest.txt', 'manifest.xml', 'sbom.xml', 'sbom.json']): ?string
    {
        return (new ManifestHelper())->get($resources) ?? self::metadata();
    }
}
```

The `resources` argument of `MyCallbacks::manifest` callable identify a priority of files list that try to search for in
the root of the PHP Archive.
The `ManifestHelper` component is in charge to find and retrieve the resource contents (if exists).
Otherwise, fallback strategy is to return the contents that will be used for the PHAR `metadata` field.

Compile your PHP Archive as usual, either with standard `vendor/bin/box compile` command or the `bin/box-manifest box:compile` command.

```shell
bin/box-manifest box:compile --config app-fixtures-box.json -v
```

<details>
<summary>TL;DR output</summary>

```text
    ____
   / __ )____  _  __
  / __  / __ \| |/_/
 / /_/ / /_/ />  <
/_____/\____/_/|_|


Box version 4.3.8@5534406

 // Loading the configuration file "app-fixtures-box.json".

ðŸ”¨  Building the PHAR "/shared/backups/bartlett/box-manifest/examples/app-fixtures/app-fixtures.phar"

? Removing the existing PHAR "/shared/backups/bartlett/box-manifest/examples/app-fixtures/app-fixtures.phar"
? Checking Composer compatibility
    > '/usr/local/bin/composer' '--version'
    > 2.5.4 (Box requires ^2.2.0)
    > Supported version detected
? No compactor to register
? Adding main file: /shared/backups/bartlett/box-manifest/examples/app-fixtures/index.php
? Adding requirements checker
? Adding binary files
    > 34 file(s)
? Auto-discover files? No
? Exclude dev files? Yes
? Adding files
    > 25 file(s)
? Generating new stub
  - Using shebang line: #!/usr/bin/env php
  - Using banner:
    > Generated by Humbug Box 4.3.8@5534406.
    >
    > @link https://github.com/humbug/box
? Setting metadata
  - MyCallbacks::manifest
? Dumping the Composer autoloader
    > '/usr/local/bin/composer' 'dump-autoload' '--classmap-authoritative' '--no-dev' '--ansi'
Generating optimized autoload files (authoritative)
Generated optimized autoload files (authoritative) containing 1 classes

? Removing the Composer dump artefacts
? Compressing with the algorithm "GZ"
    > Warning: the extension "zlib" will now be required to execute the PHAR
? Setting file permissions to 0755
* Done.

No recommendation found.
No warning found.

 // PHAR: 58 files (46.67KB)
 // You can inspect the generated PHAR with the "info" command.

 // Memory usage: 12.32MB (peak: 12.78MB), time: <1sec

```

</details>

Look in especially about this one :

```text
? Setting metadata
  - MyCallbacks::manifest
```

The `"metadata": "MyCallbacks::manifest"` setting of the BOX config file is printed rather than be replaced by its results
because the callable defined is out of autoloader scope !

**CAUTION** Your callable function must be readable by your autoloader.

That means, you should specify by the `--bootstrap` option where is the file that contains the callable.

**IMPORTANT** Use the `bin/box-compile` command here, because standard BOX compile version does not support the `--bootstrap` option.

```shell
bin/box-manifest box:compile --config app-fixtures-box.json --bootstrap bootstrap.php
```

And we will get the expected results :

```text
? Setting metadata
  - 3.x-dev@b526ccc
```

[metadata-box-setting]: https://github.com/box-project/box/blob/main/doc/configuration.md#metadata-metadata
[php-callables]: https://www.php.net/manual/en/language.types.callable.php
